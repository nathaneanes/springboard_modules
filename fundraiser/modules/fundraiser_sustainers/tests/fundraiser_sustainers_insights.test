<?php

class FundraiserSustainersInsightsTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Fundraiser Sustainers Insights',
      'description' => 'Test the Fundraiser Sustainers Insights data.',
      'group' => 'Fundraiser Sustainers',
    );
  }

  public function setUp() {
    $modules = array(
      'fundraiser_sustainers',
      'fundraiser_commerce',
      'encrypt',
    );
    parent::setUp($modules);
  }

  public function testSnapshots() {
    $today = new DateTime();
    $insights = new FundraiserSustainersInsights();
    $today_snapshot = $insights->getTodaysSnapshot();

    $this->assertEqual($today_snapshot->getDate()->format('Y-m-d'), $today->format('Y-m-d'), 'Today\'s date and the snapshot date match.');

    $snapshot = $insights->getSnapshot(new DateTime('2013-12-01'));
    $this->assertEqual($snapshot->getDate(), new DateTime('2013-12-01'), 'Date reported by snapshot matches.');
  }

  public function testHistoricalReports() {
    $insights = new FundraiserSustainersInsights();

    $report = $insights->getHistoricalReport(new DateTime('2014-11-01'), new DateTime('2014-12-01'));
    $this->debugReport($report, 30);

    $last_ten_days = $insights->getHistoricalReportPreset('10 days');
    $this->debugReport($last_ten_days, 10);
  }

  public function testForecasts() {
    $insights = new FundraiserSustainersInsights();

    $report = $insights->getForecast(new DateTime('2016-11-01'), new DateTime('2016-12-01'));
    $this->debugReport($report, 30);

    $future_ten_days = $insights->getForecastPreset('10 days');
    $this->debugReport($future_ten_days, 10);
  }

  public function testSnapshotData() {
    $snapshot = new MockFundraiserSustainersDailySnapshot(new DateTime());

    $this->assertIdentical($snapshot->getScheduledCharges(), 1);
    $this->assertIdentical($snapshot->getScheduledValue(), 200);

    $this->assertIdentical($snapshot->getRetriedCharges(), 13);
    $this->assertIdentical($snapshot->getRetriedValue(), 1400);

    $this->assertIdentical($snapshot->getProcessedCharges(), 8);
    $this->assertIdentical($snapshot->getProcessedValue(), 1000);

    $this->assertIdentical($snapshot->getRescheduledCharges(), 9);
    $this->assertIdentical($snapshot->getRescheduledValue(), 1000);

    $this->assertIdentical($snapshot->getAbandonedCharges(), 7);
    $this->assertIdentical($snapshot->getAbandonedValue(), 800);

    $this->assertIdentical($snapshot->getTotalValue(), 200);
    $this->assertIdentical($snapshot->getSuccesses(), 3);
    $this->assertIdentical($snapshot->getFailures(), 5);
  }

  protected function debugReport(FundraiserSustainersSnapshotReport $report, $count) {
    $snapshots = $report->getSnapshots();
    $this->assertEqual(count($snapshots), $count, 'Got the expected number of snapshots.');
    foreach ($snapshots as $key => $snapshot) {
      $this->assertEqual($key, $snapshot->getDate()->format('Y-m-d'), 'Array key for snapshot matches snapshot date.');
    }
  }
}

class MockFundraiserSustainersDailySnapshot extends FundraiserSustainersDailySnapshot {

  public function mockSnapshotDate() {
    $i = 0;
    return array(
      0 => array(
        'scheduledCharges' => ++$i,
        'scheduledValue' => ++$i * 100,
        'successes' => ++$i,
        'successValue' => ++$i * 100,
        'failures' => ++$i,
        'failureValue' => ++$i * 100,
        'abandonedCharges' => ++$i,
        'abandonedValue' => ++$i * 100,
        'rescheduledCharges' => ++$i,
        'rescheduledValue' => ++$i * 100,
        'processedCharges' => ++$i,
        'processedValue' => ++$i * 100,
        'retriedCharges' => ++$i,
        'retriedValue' => ++$i * 100,
      ),
    );
  }

  protected function load() {
    $data = $this->mockSnapshotDate()[0];
    foreach ($data as $key => $value) {
      $this->$key = $value;
    }
  }
}
